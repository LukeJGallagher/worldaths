name: Update KSA Athlete Profiles

on:
  schedule:
    # Run daily at 3 AM UTC (after main scraper)
    - cron: '0 3 * * *'
  workflow_dispatch:
    inputs:
      country_code:
        description: 'Country code to scrape (e.g., KSA, UAE, QAT)'
        required: false
        default: 'KSA'

env:
  PYTHON_VERSION: '3.11'

jobs:
  update-profiles:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas httpx tqdm aiofiles

      - name: Run GraphQL Profile Scraper
        run: |
          python scrape_ksa_profiles_graphql.py
        timeout-minutes: 30
        env:
          COUNTRY_CODE: ${{ github.event.inputs.country_code || 'KSA' }}

      - name: Update profiles from scraped data
        run: |
          # Also run the CSV-based updater to sync with main scraper data
          python update_ksa_profiles_from_scraped.py
        if: always()

      - name: Generate profile summary
        run: |
          python -c "
          import sqlite3
          import os

          db_path = 'SQL/ksa_athlete_profiles.db'
          if not os.path.exists(db_path):
              print('Database not found')
              exit(0)

          conn = sqlite3.connect(db_path)
          cursor = conn.cursor()

          print('=== KSA ATHLETE PROFILES SUMMARY ===')

          # Count athletes
          cursor.execute('SELECT COUNT(*) FROM ksa_athletes')
          total = cursor.fetchone()[0]
          print(f'Total Athletes: {total}')

          # With complete data
          cursor.execute('SELECT COUNT(*) FROM ksa_athletes WHERE best_score IS NOT NULL')
          with_score = cursor.fetchone()[0]
          print(f'With WPA Score: {with_score}')

          cursor.execute('SELECT COUNT(*) FROM ksa_athletes WHERE photo_url IS NOT NULL')
          with_photo = cursor.fetchone()[0]
          print(f'With Photos: {with_photo}')

          # PBs and rankings
          cursor.execute('SELECT COUNT(*) FROM athlete_pbs')
          pbs = cursor.fetchone()[0]
          print(f'Personal Bests: {pbs}')

          cursor.execute('SELECT COUNT(*) FROM athlete_rankings')
          rankings = cursor.fetchone()[0]
          print(f'Event Rankings: {rankings}')

          # Top 5 athletes
          print('\\n=== TOP 5 KSA ATHLETES ===')
          cursor.execute('''
              SELECT full_name, primary_event, best_score, best_world_rank
              FROM ksa_athletes
              WHERE best_score IS NOT NULL
              ORDER BY best_score DESC
              LIMIT 5
          ''')
          for row in cursor.fetchall():
              rank = f'#{row[3]}' if row[3] else '-'
              print(f'{row[0]} | {row[1]} | {row[2]:.0f} pts | World {rank}')

          conn.close()
          "

      - name: Upload profile database
        uses: actions/upload-artifact@v4
        if: hashFiles('SQL/ksa_athlete_profiles.db') != ''
        with:
          name: ksa-profiles-${{ github.run_number }}
          path: |
            SQL/ksa_athlete_profiles.db
            SQL/KSA_complete_profiles.csv
          retention-days: 30
          if-no-files-found: warn

      - name: Commit and push updated profiles
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          # Add database and CSV files
          git add SQL/ksa_athlete_profiles.db || true
          git add SQL/KSA_complete_profiles.csv || true

          # Check if there are changes
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Auto-update: KSA athlete profiles $(date +'%Y-%m-%d')"
            git push
          fi

      - name: Summary
        run: |
          echo "## KSA Athlete Profiles Update" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Run Date:** $(date +'%Y-%m-%d %H:%M UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**Country:** ${{ github.event.inputs.country_code || 'KSA' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Get stats from database
          python -c "
          import sqlite3
          import os

          db_path = 'SQL/ksa_athlete_profiles.db'
          if os.path.exists(db_path):
              conn = sqlite3.connect(db_path)
              cursor = conn.cursor()

              cursor.execute('SELECT COUNT(*) FROM ksa_athletes')
              total = cursor.fetchone()[0]

              cursor.execute('SELECT COUNT(*) FROM athlete_pbs')
              pbs = cursor.fetchone()[0]

              cursor.execute('SELECT COUNT(*) FROM ksa_athletes WHERE photo_url IS NOT NULL')
              photos = cursor.fetchone()[0]

              print(f'| Metric | Count |')
              print(f'|--------|-------|')
              print(f'| Athletes | {total} |')
              print(f'| Personal Bests | {pbs} |')
              print(f'| With Photos | {photos} |')

              conn.close()
          " >> $GITHUB_STEP_SUMMARY

  # NOTE: Azure sync is handled by convert_to_parquet.py in the weekly_sync workflow.
  # Profile DB is committed to git by the update-profiles job above.
